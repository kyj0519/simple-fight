<!DOCTYPE html>
<html>
<head>
  <style>
    body {
      text-align: center;
      margin-top: 20px;
      font-family: Arial, sans-serif;
    }

    .title {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
    }

    .side {
      width: 150px;
      text-align: center;
    }

    .side-title {
      font-size: 14px;
      margin-bottom: 10px;
    }

    .char-btn {
      display: block;
      width: 100%;
      height: 40px;
      margin: 5px 0;
      background-color: lightgray;
      border: 1px solid #333;
      cursor: pointer;
    }

    .char-btn.selected {
      background-color: gray;
    }

    .game-area {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .square {
      width: 500px;
      height: 500px;
      background-color: white;
      border: 2px solid black;
      position: relative;
    }

    #gameCanvas {
      display: block;
    }

    .hp-display {
      display: flex;
      justify-content: space-between;
      width: 500px;
      margin-top: 8px;
      font-weight: bold;
      font-size: 18px;
    }

    .start-btn, .reset-btn {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    .reset-btn {
      margin-left: 10px;
    }
  </style>
</head>
<body>

  <div class="title">simple fight</div>

  <div class="container">
    <div class="side">
      <div class="side-title">1P 캐릭터 선택</div>
      <button class="char-btn" data-player="1" data-type="0">???</button>
      <button class="char-btn" data-player="1" data-type="1">캐릭터 1</button>
      <button class="char-btn" data-player="1" data-type="2">캐릭터 2</button>
    </div>

    <div class="game-area">
      <div class="square">
        <canvas id="gameCanvas" width="500" height="500"></canvas>
      </div>
      <div class="hp-display">
        <div id="hp1">1P HP: 100</div>
        <div id="hp2">2P HP: 100</div>
      </div>
    </div>

    <div class="side">
      <div class="side-title">2P 캐릭터 선택</div>
      <button class="char-btn" data-player="2" data-type="0">???</button>
      <button class="char-btn" data-player="2" data-type="1">캐릭터 1</button>
      <button class="char-btn" data-player="2" data-type="2">캐릭터 2</button>
    </div>
  </div>

  <button id="startBtn" class="start-btn">Start</button>
  <button id="resetBtn" class="reset-btn">Reset</button> <!-- 초기화 버튼 추가 -->

  <script>
    const buttons = document.querySelectorAll('.char-btn');
    let selectedChars = { 1: null, 2: null };
    let selectedTypes = { 1: null, 2: null };

    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        const player = btn.dataset.player;
        buttons.forEach(b => {
          if (b.dataset.player === player) b.classList.remove('selected');
        });
        btn.classList.add('selected');

        if (btn.dataset.type === '0') {
          // ??? 선택 시, 각 플레이어별로 독립 랜덤 타입 부여
          const randType = Math.random() < 0.5 ? 1 : 2;
          selectedTypes[player] = randType;
          selectedChars[player] = `캐릭터 ${randType} (랜덤)`;
        } else {
          selectedTypes[player] = Number(btn.dataset.type);
          selectedChars[player] = btn.textContent;
        }
      });
    });

    document.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 'k') {
        buttons.forEach(b => b.classList.remove('selected'));
        selectedChars = { 1: null, 2: null };
        selectedTypes = { 1: null, 2: null };
      }
    });

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    let characters = [];
    let gameRunning = false;

    let hp1 = 100;
    let hp2 = 100;
    const hp1Display = document.getElementById('hp1');
    const hp2Display = document.getElementById('hp2');

    let item = null;
    let invincible = { 1: false, 2: false };
    let itemIntervalId = null;

    const SPEED_INCREMENT = 0.5;

    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');

    startBtn.addEventListener('click', () => {
      if (!selectedChars[1] || !selectedChars[2]) {
        alert('1P와 2P 캐릭터를 모두 선택하세요!');
        return;
      }
      startGame();
      startBtn.disabled = true; // 시작 후 버튼 비활성화
    });

    resetBtn.addEventListener('click', () => {
      resetGame();
      startBtn.disabled = false; // 리셋 시 시작 버튼 활성화
    });

    function startGame() {
      hp1 = 100;
      hp2 = 100;
      updateHP();
      invincible = { 1: false, 2: false };
      characters = [
        createCharacter(100, 250, 'red', selectedTypes[1]),
        createCharacter(400, 250, 'blue', selectedTypes[2])
      ];
      spawnItem();

      if (itemIntervalId) clearInterval(itemIntervalId);
      itemIntervalId = setInterval(() => {
        if (!item) spawnItem();
      }, 5000);

      gameRunning = true;
      gameLoop();
    }

    function resetGame() {
      gameRunning = false;
      if (itemIntervalId) {
        clearInterval(itemIntervalId);
        itemIntervalId = null;
      }
      hp1 = 100;
      hp2 = 100;
      updateHP();
      invincible = { 1: false, 2: false };
      item = null;
      characters = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      buttons.forEach(b => b.classList.remove('selected'));
      selectedChars = { 1: null, 2: null };
      selectedTypes = { 1: null, 2: null };
    }

    function createCharacter(x, y, color, type) {
      const angle = Math.random() * Math.PI * 2;
      const baseSpeed = 3;
      return {
        x,
        y,
        baseRadius: 20,
        hitCount: 0,
        dx: Math.cos(angle) * baseSpeed,
        dy: Math.sin(angle) * baseSpeed,
        color,
        type,
        baseSpeed,
      };
    }

    function spawnItem() {
      const radius = 10;
      const x = Math.random() * (canvas.width - 2 * radius) + radius;
      const y = Math.random() * (canvas.height - 2 * radius) + radius;
      item = { x, y, radius, color: 'yellow' };
    }

    function gameLoop() {
      if (!gameRunning) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      moveCharacters();
      drawCharacters();
      drawItem();

      requestAnimationFrame(gameLoop);
    }

    function moveCharacters() {
      for (let i = 0; i < characters.length; i++) {
        const char = characters[i];
        char.x += char.dx;
        char.y += char.dy;

        if (char.x - getRadius(char) < 0) {
          char.x = getRadius(char);
          char.dx = Math.abs(char.dx);
        }
        if (char.x + getRadius(char) > canvas.width) {
          char.x = canvas.width - getRadius(char);
          char.dx = -Math.abs(char.dx);
        }
        if (char.y - getRadius(char) < 0) {
          char.y = getRadius(char);
          char.dy = Math.abs(char.dy);
        }
        if (char.y + getRadius(char) > canvas.height) {
          char.y = canvas.height - getRadius(char);
          char.dy = -Math.abs(char.dy);
        }

        if (item) {
          const dx = char.x - item.x;
          const dy = char.y - item.y;
          const dist = Math.sqrt(dx * dx + dy * dy);
          if (dist < getRadius(char) + item.radius) {
            invincible[i + 1] = true;
            item = null;
          }
        }
      }

      const [a, b] = characters;
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const distance = Math.sqrt(dx * dx + dy * dy);

      if (distance < getRadius(a) + getRadius(b)) {
        const nx = dx / distance;
        const ny = dy / distance;

        [a, b].forEach((char) => {
          const vDotN = char.dx * nx + char.dy * ny;
          char.dx = char.dx - 2 * vDotN * nx;
          char.dy = char.dy - 2 * vDotN * ny;
          normalizeSpeed(char);
        });

        const overlap = (getRadius(a) + getRadius(b) - distance) / 2;
        a.x -= overlap * nx;
        a.y -= overlap * ny;
        b.x += overlap * nx;
        b.y += overlap * ny;

        // 충돌 시 캐릭터 1 속도 증가
        [a, b].forEach((char) => {
          if (char.type === 1) {
            char.baseSpeed += 0.5;
            normalizeSpeed(char);
          }
        });

        // 캐릭터 2 충돌 횟수 증가
        if (a.type === 2) a.hitCount++;
        if (b.type === 2) b.hitCount++;

        // HP 감소 및 무적 처리
        if (invincible[1] && invincible[2]) {
          // 둘 다 무적 시 HP 감소 없음
        } else if (invincible[1]) {
          hp2--;
          invincible[1] = false;
        } else if (invincible[2]) {
          hp1--;
          invincible[2] = false;
        } else {
          hp1--;
          hp2--;
        }

        updateHP();

        if (hp1 <= 0 || hp2 <= 0) {
          endGame();
        }
      }
    }

    function getRadius(char) {
      if (char.type === 2) {
        return char.baseRadius + char.hitCount * 2;
      }
      return char.baseRadius;
    }

    function normalizeSpeed(char) {
      const speed = Math.sqrt(char.dx * char.dx + char.dy * char.dy);
      if (speed === 0) {
        const angle = Math.random() * 2 * Math.PI;
        char.dx = Math.cos(angle) * char.baseSpeed;
        char.dy = Math.sin(angle) * char.baseSpeed;
        return;
      }
      char.dx = (char.dx / speed) * char.baseSpeed;
      char.dy = (char.dy / speed) * char.baseSpeed;
    }

    function drawCharacters() {
      for (let i = 0; i < characters.length; i++) {
        const char = characters[i];
        const radius = getRadius(char);
        ctx.beginPath();
        ctx.arc(char.x, char.y, radius, 0, Math.PI * 2);
        ctx.fillStyle = char.color;
        ctx.fill();

        if (invincible[i + 1]) {
          ctx.strokeStyle = 'yellow';
          ctx.lineWidth = 5;
        } else {
          ctx.strokeStyle = 'black';
          ctx.lineWidth = 1;
        }
        ctx.stroke();
      }
    }

    function drawItem() {
      if (!item) return;
      ctx.beginPath();
      ctx.arc(item.x, item.y, item.radius, 0, Math.PI * 2);
      ctx.fillStyle = item.color;
      ctx.fill();
      ctx.strokeStyle = 'goldenrod';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function updateHP() {
      hp1Display.textContent = `1P HP: ${hp1}`;
      hp2Display.textContent = `2P HP: ${hp2}`;
    }

    function endGame() {
      gameRunning = false;
      if (itemIntervalId) {
        clearInterval(itemIntervalId);
        itemIntervalId = null;
      }
      alert(
        hp1 <= 0 && hp2 <= 0
          ? '무승부!'
          : hp1 <= 0
          ? '2P 승리!'
          : '1P 승리!'
      );
      startBtn.disabled = false; // 게임 종료 후 시작 버튼 활성화
    }
  </script>
</body>
</html>
